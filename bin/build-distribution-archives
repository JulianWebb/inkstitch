#!/bin/bash

VERSION="$(echo ${GITHUB_REF} | sed -e 's|refs/heads/||' -e 's|refs/tags/||' -e 's|/|-|g')"
OS="${BUILD:-$(uname)}"
ARCH="$(uname -m)"
mkdir artifacts
if [ "$BUILD" = "osx" ]; then
    cp -a images/examples palettes symbols fonts inx LICENSE VERSION dist/inkstitch.app/Contents
    cp -a icons locales print dist/inkstitch.app/Contents/MacOS
    cp -a electron/build/mac dist/inkstitch.app/Contents/electron
    rm -rf dist/inkstitch/
    mv dist/inkstitch.app build/
    temp_path="/tmp/inkstitch/"
    mkdir mac/
    # inside the scripts folder are:
    # - preinstaller (checks for previously installed inkstitch and deletes it) and
    # - postinstaller (moves inkstitch folder from /tmp to user Inkscape extensions folder in $HOME)
    # The postinstaller is a workaround for a proper way to install in user $HOME space

    # Build on GitHub will be handled differently from local builds
    # local builds will not be signed. They are run to produce releases for lecacy versions of macOS
    if [[ -z ${GITHUB_REF} ]]
    then
        pkgbuild --root build/inkstitch.app --component-plist installer_scripts/inkstitch.plist --ownership recommended --identifier org.inkstitch.app --version ${VERSION} --scripts installer_scripts/scripts --install-location ${temp_path}inkstitch.app mac/installer.pkg
        cp installer_scripts/distribution.plist mac
        cd mac
        # inside folder resource is inkstitch image for the installer background
        productbuild --distribution distribution.plist --resources ../installer_scripts/resource --package-path installer.pkg ../artifacts/inkstitch-${VERSION}.pkg

    else
        # This code signs and notarize the inkstitch.app
        echo "Running import-macos-keys"
        bash bin/import-macos-keys
        echo "Done import-macos-keys"
        DEV_IDENT="Developer ID Application: Lex Neva (929A568N58)"
        echo "Singing of inkstitch.app"
        /usr/bin/codesign --force \
                    --sign ${DEV_IDENT} \
                    --deep \
                    --entitlements installer_scripts/entitlements.plist \
                    --options runtime \
                    --timestamp \
                    build/inkstitch.app -v
        echo "Done signing inkstitch.app"
        echo "App Signing Verification"
        spctl -a -vv build/inkstitch.app
        echo "Running pkgbuild"
        pkgbuild --root build/inkstitch.app \
                --component-plist installer_scripts/inkstitch.plist \
                --ownership recommended \
                --identifier org.inkstitch.app \
                --version ${VERSION} \
                --scripts installer_scripts/scripts \
                --sign ${DEV_IDENT} \
                --install-location ${temp_path}inkstitch.app \
                mac/installer.pkg
        echo "pkgbuild done."
        cp installer_scripts/distribution.plist mac
        cd mac
        # inside folder resource is inkstitch image for the installer background
        echo "Running productbuild"
        productbuild --distribution distribution.plist \
                    --resources ../installer_scripts/resource \
                    --package-path \
                    installer.pkg ../artifacts/inkstitch-${VERSION}.pkg
        echo "productbuild done."
        cd ..
        # signing the pkg
        echo "Signing inkstitch.pkg"
        /usr/bin/codesign --force \
                    --sign ${DEV_IDENT} \
                    --entitlements entitlements.plist \
                    --timestamp \
                    artifacts/inkstitch-${VERSION}.pkg
        echo "Done sinining inkstitch.pkg"
        echo "Notary starting"
        bash bin/notarize-app ${APPLE_USER} ${APPLE_PASS} 'org.inkstitch.app' artifacts/inkstitch-${VERSION}.pkg
        echo "Done with Notary"
    fi
else
    cp -a images/examples palettes symbols fonts inx LICENSE VERSION dist/inkstitch
    cp -a icons locales print dist/inkstitch/bin
    cp -a electron/build/*-unpacked dist/inkstitch/electron

fi

if [ "$BUILD" = "windows" ]; then
    mkdir win
    cp installer_scripts/template.iss win/win_build.iss
    # adds the year and version for the inno installer
    info_year=$( date "+%Y" )
    copyright_year="#define COPYRIGHT \""${info_year}"\" + URL"
	version_block="#define VERSION \""${VERSION}"\""
	sed -i'' -e '/;inkstitch-year/ a\'$'\n'"${copyright_year}"'' win/win_build.iss
	sed -i'' -e '/;inkstitch-version/ a\'$'\n'"${version_block}"'' win/win_build.iss

    iscc win/win_build.iss
	mv  win/inkstitch.exe artifacts/inkstitch-${VERSION}.exe
fi

if [ "$BUILD" = "linux" ]; then
    cd dist
    python -m zipfile -c ../artifacts/inkstitch-${VERSION}-${OS}.zip *;
    cd ..
fi
